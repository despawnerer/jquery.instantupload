/*!
 * jQuery Instant Upload plugin, v0.1
 *
 * Copyright 2010, Alexey Shelf
 * Licensed under GPLv3 or later.
 * http://www.gnu.org/licenses/
 */

(function($){$.fn.upload=function(options){options=$.extend({url:'',name:'',enctype:'multipart/form-data',select:function(filename,id){return true;},submit:function(id){},error:function(error,id){},success:function(response,id){},complete:function(id){}},options);this.each(function(){new Uploader(this,options);});return this;},Uploader=function(element,options){this.element=$(element);this.options=options;var form=this.element.closest('form');if(form.length>0&&!this.options.url){this.options.url=form.attr('action');}
if(!this.options.name){this.options.name=this.element.attr('name');}
this.regenerate();}
Uploader.prototype.regenerate=function(){var self=this;this.id=new Date().getTime().toString().substr(8);var position=this.element.css('position');if(position!='absolute'&&position!='relative'){this.element.css('position','relative');}
this.frame=$('<iframe></iframe>').attr('id','iframe-'+this.id).attr('name','iframe-'+this.id).css('display','none').appendTo(this.element);this.form=$('<form></form>').attr('method','post').attr('enctype',this.options.enctype).attr('action',this.options.url).attr('target','iframe-'+this.id).css({position:'absolute','text-align':'right',right:0,top:0,margin:0,padding:0,overflow:'hidden',width:'100%',height:'100%',opacity:0,cursor:this.element.css('cursor')}).appendTo(this.element)
this.input=$('<input/>').attr('name',this.options.name).attr('type','file').css({position:'absolute',right:0,top:0,cursor:this.element.css('cursor')}).appendTo(this.form);if(this.element.innerHeight()>0){this.input.css({height:this.element.innerHeight()+'px','font-size':this.element.innerHeight()+'px'});}
if($.browser.msie){this.element.mouseover(function(event){self.input.focus();});}
this.input.change(function(){var filename=self.input.val();if(self.options.select(filename,self.id)!=false){self.submit();}});}
Uploader.prototype.submit=function(){var self=this;this.options.submit(this.id);this.form.appendTo('body').submit();var id=this.id;this.frame.unbind('load').load(function(event){var document=this.contentWindow.document;if(document){var response=$(this.contentWindow.document.body).html();self.options.success(response,id);}else{self.options.error('not_loaded',id);}
self.options.complete(id);$(this).remove();});this.form.remove();this.regenerate();}})(jQuery);
